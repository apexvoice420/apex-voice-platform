generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Client {
  id            String         @id @default(cuid())
  name          String
  domain        String?
  vapiApiKey    String?
  settings      Json           @default("{}")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  agents        Agent[]
  contacts      Contact[]
  conversations Conversation[]
  opportunities Opportunity[]
  pipelines     Pipeline[]
  users         User[]
  workflows     Workflow[]
}

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  password    String
  displayName String
  photoURL    String?
  role        Role      @default(user)
  clientId    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  client      Client    @relation(fields: [clientId], references: [id])
}

model Contact {
  id              String         @id @default(cuid())
  clientId        String
  firstName       String
  lastName        String?
  email           String?
  phone           String?
  tags            String[]       @default([])
  customFields    Json           @default("{}")
  pipelineStageId String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?
  client          Client         @relation(fields: [clientId], references: [id])
  conversations   Conversation[]
  opportunities   Opportunity[]
}

model Pipeline {
  id            String        @id @default(cuid())
  clientId      String
  name          String
  stages        Json          @default("[]")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?
  opportunities Opportunity[]
  client        Client        @relation(fields: [clientId], references: [id])
}

model Opportunity {
  id         String            @id @default(cuid())
  clientId   String
  pipelineId String
  stageId    String
  contactId  String
  value      Float             @default(0)
  status     OpportunityStatus @default(open)
  title      String
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  deletedAt  DateTime?
  client     Client            @relation(fields: [clientId], references: [id])
  contact    Contact           @relation(fields: [contactId], references: [id])
  pipeline   Pipeline          @relation(fields: [pipelineId], references: [id])
}

model Conversation {
  id            String             @id @default(cuid())
  clientId      String
  contactId     String
  lastMessageAt DateTime           @default(now())
  snippet       String             @default("")
  status        ConversationStatus @default(open)
  unreadCount   Int                @default(0)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  deletedAt     DateTime?
  client        Client             @relation(fields: [clientId], references: [id])
  contact       Contact            @relation(fields: [contactId], references: [id])
  messages      Message[]
}

model Message {
  id             String           @id @default(cuid())
  conversationId String
  channel        ChannelType
  direction      MessageDirection
  content        String
  status         MessageStatus    @default(sent)
  metadata       Json             @default("{}")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  deletedAt      DateTime?
  conversation   Conversation     @relation(fields: [conversationId], references: [id])
}

model Agent {
  id            String    @id @default(cuid())
  clientId      String
  vapiAgentId   String
  name          String
  phoneNumberId String?
  config        Json      @default("{}")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?
  client        Client    @relation(fields: [clientId], references: [id])
}

model Workflow {
  id        String    @id @default(cuid())
  clientId  String
  name      String
  isActive  Boolean   @default(false)
  trigger   Json      @default("{}")
  steps     Json      @default("[]")
  version   Int       @default(1)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  client    Client    @relation(fields: [clientId], references: [id])
}

enum Role {
  super_admin
  client_admin
  user
}

enum OpportunityStatus {
  open
  won
  lost
}

enum ConversationStatus {
  open
  closed
}

enum ChannelType {
  sms
  email
  voice
}

enum MessageDirection {
  inbound
  outbound
}

enum MessageStatus {
  sent
  delivered
  read
  failed
}
